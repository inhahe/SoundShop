cmake_minimum_required(VERSION 3.15)
project(juce_audio_bindings)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Windows-specific settings
if(WIN32)
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>DLL")
endif()

# Find Python
find_package(Python COMPONENTS Interpreter Development REQUIRED)

# Find pybind11
find_package(pybind11 REQUIRED)

# Add JUCE subdirectory (but don't use its high-level functions)
add_subdirectory(JUCE)

# Create the Python module
pybind11_add_module(juce_audio juce_audio_bindings.cpp)

# Set compile features
target_compile_features(juce_audio PRIVATE cxx_std_17)

# Add JUCE module include directories manually
target_include_directories(juce_audio PRIVATE
    JUCE/modules
    JUCE/modules/juce_audio_basics
    JUCE/modules/juce_audio_devices  
    JUCE/modules/juce_audio_formats
    JUCE/modules/juce_audio_processors
    JUCE/modules/juce_audio_utils
    JUCE/modules/juce_core
    JUCE/modules/juce_data_structures
    JUCE/modules/juce_events
    JUCE/modules/juce_graphics
    JUCE/modules/juce_gui_basics
    JUCE/modules/juce_gui_extra
)

# JUCE compile definitions
target_compile_definitions(juce_audio PRIVATE
    JUCE_GLOBAL_MODULE_SETTINGS_INCLUDED=1
    JUCE_STANDALONE_APPLICATION=1
    JUCE_MODULE_AVAILABLE_juce_audio_basics=1
    JUCE_MODULE_AVAILABLE_juce_audio_devices=1
    JUCE_MODULE_AVAILABLE_juce_audio_formats=1
    JUCE_MODULE_AVAILABLE_juce_audio_processors=1
    JUCE_MODULE_AVAILABLE_juce_audio_utils=1
    JUCE_MODULE_AVAILABLE_juce_core=1
    JUCE_MODULE_AVAILABLE_juce_data_structures=1
    JUCE_MODULE_AVAILABLE_juce_events=1
    JUCE_MODULE_AVAILABLE_juce_graphics=1
    JUCE_MODULE_AVAILABLE_juce_gui_basics=1
    JUCE_MODULE_AVAILABLE_juce_gui_extra=1
)

# Windows-specific definitions and libraries
if(WIN32)
    target_compile_definitions(juce_audio PRIVATE
        JUCE_WINDOWS=1
        JUCE_WIN32=1
        JUCE_WASAPI=1
        JUCE_DIRECTSOUND=1
        JUCE_WEB_BROWSER=0
        JUCE_USE_CURL=0
        JUCE_REPORT_APP_USAGE=0
        JUCE_DISPLAY_SPLASH_SCREEN=0
        JUCE_USE_DARK_SPLASH_SCREEN=0
        JUCE_APPLICATION_NAME_STRING="JUCE Audio Python"
        JUCE_APPLICATION_VERSION_STRING="1.0.0"
        WIN32_LEAN_AND_MEAN=1
        NOMINMAX=1
        _WIN32_WINNT=0x0601
    )
    
    # Windows system libraries
    target_link_libraries(juce_audio PRIVATE
        winmm
        ole32
        oleaut32
        imm32
        comdlg32
        shlwapi
        rpcrt4
        wininet
        version
        ws2_32
        kernel32
        user32
        gdi32
        winspool
        shell32
        uuid
        odbc32
        odbccp32
        advapi32
        comctl32
    )
endif()

# Set output properties
if(WIN32)
    set_target_properties(juce_audio PROPERTIES
        SUFFIX ".pyd"
        DEBUG_POSTFIX ""
    )
endif()

# Compiler-specific settings
if(MSVC)
    target_compile_options(juce_audio PRIVATE
        /W3
        /bigobj
        /permissive-
        /EHsc
        /MP  # Multi-processor compilation
    )
    
    # Release optimizations
    target_compile_options(juce_audio PRIVATE
        $<$<CONFIG:Release>:/O2>
        $<$<CONFIG:Release>:/Oi>
    )
    
    # Debug settings  
    target_compile_options(juce_audio PRIVATE
        $<$<CONFIG:Debug>:/Od>
        $<$<CONFIG:Debug>:/Zi>
    )
endif()

# Add JUCE source files manually (since we can't use juce_add_module)
file(GLOB_RECURSE JUCE_SOURCES 
    "JUCE/modules/juce_audio_basics/juce_audio_basics.cpp"
    "JUCE/modules/juce_audio_devices/juce_audio_devices.cpp"
    "JUCE/modules/juce_audio_formats/juce_audio_formats.cpp" 
    "JUCE/modules/juce_audio_processors/juce_audio_processors.cpp"
    "JUCE/modules/juce_audio_utils/juce_audio_utils.cpp"
    "JUCE/modules/juce_core/juce_core.cpp"
    "JUCE/modules/juce_data_structures/juce_data_structures.cpp"
    "JUCE/modules/juce_events/juce_events.cpp"
    "JUCE/modules/juce_graphics/juce_graphics.cpp"
    "JUCE/modules/juce_gui_basics/juce_gui_basics.cpp"
    "JUCE/modules/juce_gui_extra/juce_gui_extra.cpp"
)

# Add the JUCE sources to our target
target_sources(juce_audio PRIVATE ${JUCE_SOURCES})